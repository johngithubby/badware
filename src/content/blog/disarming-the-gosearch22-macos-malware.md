---
title: 'Disarming the GoSearch22 macOS Malware'
description: 'Why GoSearch22 exits with -1 under LLDB and how to re-sign it so you can actually debug it.'
pubDate: 'Sep 30 2025'
heroImage: '../../assets/blog-placeholder-5.jpg'
---

This malware employs several anti-debug techniques, as laid out in the last chapter of the Blue Fox book. If you just launch it straight under LLDB (for example: `lldb GoSearch22.app`), the book claims it will immediately exit with code `45` because it calls `ptrace` (or `syscall` wrapper) using the `PT_DENY_ATTACH` flag.

When I tried it myself, that's not what actually happened: it exited with `-1`.

Why?

## Observed behavior

macOS Console (search for `debugserver`) logged:

```
[LaunchAttach] (3983) about to task_for_pid(3982)
error: [LaunchAttach] MachTask: :TaskPortForProcessID task_for_pid(3982) failed: ::task_for_pid ( target_tport = 0x8203, pid = 3982, &task) => err = 0x90800885 ((os/kern) failure)
```

That's macOS itself refusing a debugger attach *before* LLDB can properly establish the debugging session.

## Likely root causes

This can happen because of one (or both) of:

1. Code signing + hardened runtime: If the binary is signed with the hardened runtime and does **not** have the `com.apple.security.get-task-allow` entitlement, `task_for_pid()` fails for LLDB.
2. Very early `PT_DENY_ATTACH`: If the process invokes `ptrace(PT_DENY_ATTACH, ...)` extremely early (e.g. inside a constructor / `+load` / init section) the kernel denies the debugger right away.

## Verifying the signature & entitlements

Command used:

```
codesign -dvvvv --entitlements :- GoSearch22.app
```

Relevant output (trimmed):

```
Identifier=com.GoSearch22
Format=app bundle with Mach-O universal (x86_64 arm64)
CodeDirectory v=20500 size=4122 flags=0x10000(runtime)
Authority=Developer ID Application: hongsheng yan (K69G52FWT9)
TeamIdentifier=K69G52FWT9
Runtime Version=11.0.0
```

The important bit: `flags=0x10000 (runtime)` indicates the hardened runtime is enabled. There is no `get-task-allow` entitlement present. Under these conditions, macOS blocks debugger attachment via `task_for_pid`.

Therefore LLDB never reaches a state where it would report the `45` exit caused by a user‑space `PT_DENY_ATTACH`; instead you just see a failure to attach and the process terminates showing `-1` on your side.

## Making it debuggable

Strip the existing Developer ID signature (and thus the hardened runtime), then ad‑hoc sign it so macOS will still run it but allow debugging:

```
sudo codesign --remove-signature GoSearch22.app
sudo codesign -s - --force --deep GoSearch22.app
```

Explanation:

- `--remove-signature` removes the original Developer ID signature + hardened runtime restrictions.
- `-s -` applies an ad-hoc signature (a placeholder) that macOS accepts for local execution and permits debugging.
- `--deep` ensures nested Mach-O binaries inside the bundle are also (re)signed.

## Launching under LLDB after re-signing

Now you can do:

```
lldb GoSearch22.app
(lldb) settings set target.disable-aslr true
(lldb) process launch --stop-at-entry
```

At this point the debugger should successfully attach at the entry point, allowing you to inspect early initialization code (including where `PT_DENY_ATTACH` would have been called previously).

---

End of post.
